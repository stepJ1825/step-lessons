package by.step.streams;

import java.math.BigInteger;
import java.time.Clock;
import java.time.Instant;
import java.time.temporal.ChronoField;
import java.util.stream.IntStream;

public class ParallelStreams {

    private static Clock clock = Clock.systemUTC();

    public static void main(String[] args) throws InterruptedException {
        int computingAmount = 3000;
        methodWithThreadClass(computingAmount);
        System.out.println("-----------------------------------");
        parallelStreamMethod(computingAmount);
    }

    private static void methodWithThreadClass(int computingAmount) throws InterruptedException {
        Instant start = clock.instant();
        for (int i = 0; i < computingAmount; i++) {
            Thread thread = new Thread(new ManyNumbersCounter(i));
            thread.start();
            thread.join();
        }
        Instant end = clock.instant();
        showResultsAndThenReset();
        showBenchmarkStats(start, end, computingAmount);
    }

    private static void parallelStreamMethod(int computingAmount)  {
        Instant start = clock.instant();
        IntStream.range(0, computingAmount)
                .parallel()
                .forEach(i -> new ManyNumbersCounter(i).run());
        Instant end = clock.instant();
        showResultsAndThenReset();
        showBenchmarkStats(start, end, computingAmount);
    }


    private static void showResultsAndThenReset() {
        BigInteger expected = new BigInteger("13835812153849159314130387496645591587546825341177802748008943201848496749741630763517382572702633365349156690248883484139338496796629549877833336814837576633356895077364608191949668539758658754704483931086160996583964296166248983054934230855669410954747026659722191852227051703865421713574117318156060510716409858652451148551456161433293273694631099013528758327313352614715929428527234840168363704679691134165853561189905069060733828237138202744922350729640286660473460475392180633177742147699472430981246084389968450128201219464644995668203731424884904804559798081519692526083128733989678632759240391345133184502441481252602451029289174496458950890618572457421911097794151175124812667735809462363894758891909417403604586468255119941278231583788312057540203341228631674662572281203268783240286481939882878049246676962495774071545125468434163667908118624069042023178779614630935496043262604435468265289384147133895440011534474399995209011997600951846346586620956731713844383894050048041751306351278036574906691876363959598299705053548349433205119929408897774955274341485037949264142821636925517927501261166163482234117432819053925348311845952173299541407839482563439967689635354488468437132556002718925698693561701820383200398151831109919723667092918889921051956781374363253776341016747254855075449603222360766553053552753935951639199988967918168091235022101408387545676421490177786150476637732964787066446627741651255324331188439953622187395631232862252034997898585401867798897465301169963453328619854649928114688776818720918814746431106558082248717148221269078735072884400351153685179066779411809113629632368057671968159756227228713501206901539284662464218736609227963453754948542670320697761223269833123425451742223552811661546381245245779611970485755966094262882977997674938801876727727059160722966537067438625475794516573376043433413082844262340254013745611685905546859429901092085305966583345955400977471517889721395172924615754231480560401941363742481447683111374964054875922301743936946527685120225514378519822331408438109853160051219955365954935116447839381695652185973362760355473347689079442273440279467042624158435960565707555718830490427120026460277416581913617294734933627670977407249896730638881807555467771850024802718647967446961309492671444681302555030717418775722855166017345230681730346621990480157121105052636885588049654339839433438128181239884103519784754781389804379537302521865889270732463327703385333284674288358477946384997913514054768687466809060783805724851540474927496664121216744045510625038405077103497056349812936028023819240091882448154663839242964045134874228220354418130151105714172356373773498848930565773386001626029130851000625418750841411785724344402807381921856902732111138828429254106941131112709489873358383989941177265500340650268463591221969763468104477463651024470210357970825766008581138069153667128925694841826733320963177612251542407941607555824063605681778728992968124896599326721678000539613652524519172844141848062252518224539574593329072537094663693132347127347286668589014845690072834365054184157098437771376743350164603007295968443266532474918297786821442963276643603782251972145359154468574278206654846989096338960518180407451901515621422087322111653370603561767243608905900970842061816080444971893866441544850354456096310309312287132691476517107618321780335846947862702393907454094022463522080407632598004753192556137254357842711247470570327165764545703119101874785263707202748753724926529823270492754034672410123351787393221664215490716774132406368250071317195449703960358709574224310393206708667197796774415713574250584988621857813025768315406957229812453984483199451661817825355079061108833302301146504763434129973725032568912718922062794433886545801394729085260498274593236204493195134353072413959153222036333491635391226058062802574693952563839887674660800131220369703042902932073624243166654257469509852608359763454816477844301602564242187719022667590135875383664721063516685728835682278412856939660410689726992440702099215794904253335774778135149444598432584285204817314972447423753963826995886534976885336897357446758264177405109547457445340699996840976350252833514386761384291804778454284286145606179676167528917237758477985225462674674227933932216182453428969316602426796209329035939940744989476586933951788146300111219615270774590621123145021710028958851262256178678617687549333789874924448397068687997082575094528530672673492447843826963850937449893066862392824386150400158109875684406660636726586767026269908719686432237441203840052550118452356140338126277207990110808456263309273539537207313231009437067766853131815133801533904335801177714145077223236882607474657870230641341905351710694678270749294782234589416690935277482342050886328350747285680013430597064569733414616579676383095979796918331885636844635540279557597734825168612078502993635379800996967473905731948568333638403160039999217519753392688623267033318959548779218774110900649493845398741458003289020650852691503493827679768929055742641663644576122725653789784744756203955178113105548404720411427708894460608023314440383909238644518488229890270514209832614422638318382156832901310254419353943691282331709874344071307351802518084893880948398380624944537220080705205019946613214425567283014807096268563195628835335310159752845051561125899444726852309036876404954265143259788490792964312179841201960442690774014750480764526440876806081935918276888583697473514257542842935013716683662846244723616299320121329389440056093374363954481003244462357582981905899367838495375773776193212032367585599476379906582729322609093158671914229904711128216872657666695868814337972646649378731852259245785980828335429494011702604258761857328110244378215025172356622148054810190874601450374641886093154367361323626804014456215383464238963840440276977176355398437069005975041781326981395995405364820090203645743221351126401298984359418026894442184780144825808644171020503202142819952248142758806484969857999733446057943082113131099560349672294551156046197291938918824648024146957247112074119511288305256706896859539213391022803881188468892333142216813218810731936303233367134240998771334196150206009323369599271051105375035764040283527910769024035960406790772507732438239131587227053190518743878583246301815925596237433413044424855185014387523508410643435186968613196244501152753670512821021401219217421799780769912320183224833247367553640951254588125217741006431844241613088022769104256310016534829621571623511997313122280849426370242464754700429419455559859162080748870027747058408169881109917536251906035208313040132790954828697764676774978677200852521368116450964473612501493852585915062764383649835215472941681991546830794525461011725653779713865278363636276303218985620803126478819513678462964352354959167445759026780929220178691308518577898574840190495946144261313267669076733407129038858059940165354877144224818265514116531088548045332930860378364864051405842531152807735384265320408038821761491485137128673824838698385857973839445457257116228511791339242247898749575185334289302801837127627266660369829915127563743363634818070636946521146287472846567160949744877320448771482470502426284133530464409759636904699348839940537978112016174353183808616745616288218485369211640944422232162816540158744883090020454987661422114431852698556054742802124936370815331468430565440052817945758872163759012282815067654119199245027138214117706401117442140708356062501472627668665308592804161242194688122143762671342038403931334239292991024402505743227634109874042064938465644337434480659176051519501571300907550379644206328816182059939104124337289133532301994038892138796450213395961498234797381834321513821676665644649234934232631307100738200256220477469820614332978080405652342380422742389157527588338527327782226093897678472372430589508885223550585883457433782767869243854209735769245043097171185136507200004989819972284075635691417318282457492309171722640221203782482490036406206097451006187210769739330890346895023169422458510606199045293839138291986620641057089149902318267494665171527223191578455168380350355501452800143774900907456253032567040208663664587623235507616616142684290344150679186995334868895954395229343905046731654365295728517545787554929796376700183602448707832495448130503731326121329941713892327816671802777268341201809483608036904433688052267281359613295558923787706521071828638958390051558288410847875657108601456967475096101987434165730548965969116598352984233805697178957680419990935517493580707432780441230424632829229716105041261594083452244993017506583870024332476723942239942275630968576224669066665048909559644342959549925429103815747664276051837088059701997477107440425021981051740905844053995746925171844037841823522441611867345433208379741347009406659919379208878761799827677548449306681397552694707427117631406144007450882969740049818323455858551317207197201589704858224388374914095841726938767482243085025897244690463595978336569707778625455613570273121541638995145894561079999213500076101248781500642979091198044736325729107144579768273776743716439557581557253878204647391176582851167312182026188795156620056856503340092247479478684738621107994804323593105039052556442336528920420940314");
        BigInteger actual = ManyNumbersCounter.accumulator.get();
        System.out.println("expected equals actual: " + (expected.compareTo(actual) == 0));
        System.out.println(ManyNumbersCounter.accumulator.getAndSet(BigInteger.ZERO));
    }

    private static void showBenchmarkStats(Instant start, Instant end, int computingAmount) {
        long processTime =
                end.getLong(ChronoField.INSTANT_SECONDS) * 1000_000 +
                        end.getLong(ChronoField.MICRO_OF_SECOND) -
                        start.getLong(ChronoField.INSTANT_SECONDS) * 1000_000 -
                        start.getLong(ChronoField.MICRO_OF_SECOND);
        System.out.println("processTime: " + processTime);
        System.out.println("processTime / computingAmount: " + (processTime / computingAmount));
    }
}
